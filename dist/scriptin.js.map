{"version":3,"file":"scriptin.js","sources":["../src/lib/utils/url.js","../src/lib/ajax.js","../src/lib/events.js","../src/lib/store/dbs/indexed-db.js","../src/lib/store/dbs/localstorage.js","../src/lib/store/index.js","../src/lib/utils/dateFns.js","../src/lib/utils/general.js","../src/lib/settings.js","../src/index.js","../src/lib/utils/headers.js"],"sourcesContent":["/**\n * Copyright (c) 2024 Anthony Mugendi\n * \n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\n// Scheme: https://tools.ietf.org/html/rfc3986#section-3.1\n// Absolute URL: https://tools.ietf.org/html/rfc3986#section-4.3\nconst ABSOLUTE_URL_REGEX = /^[a-zA-Z][a-zA-Z\\d+\\-.]*?:/;\n\n// Windows paths like `c:\\`\nconst WINDOWS_PATH_REGEX = /^[a-zA-Z]:\\\\/;\n\nexport default function isAbsoluteUrl(url) {\n\tif (typeof url !== 'string') {\n\t\tthrow new TypeError(`Expected a \\`string\\`, got \\`${typeof url}\\``);\n\t}\n\n\tif (WINDOWS_PATH_REGEX.test(url)) {\n\t\treturn false;\n\t}\n\n\treturn ABSOLUTE_URL_REGEX.test(url);\n}","/**\n * Copyright (c) 2023 Anthony Mugendi\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nimport isAbsoluteUrl from './utils/url';\n\n// Ref:https://gist.github.com/Danilovonline/1b87ef2ff1b1e0b19714a8b2e6246856\nfunction httpRequest(\n  url,\n  method,\n  data,\n  opts,\n  success_callback,\n  failure_callback\n) {\n  var xhr;\n\n  // defaults options\n  var defaultOpts = { headers: {} };\n\n  method = method.toUpperCase();\n\n  // for post/put methods\n  if (['POST', 'PUT'].indexOf(method) > -1) {\n    defaultOpts.headers['content-type'] = 'application/json';\n  }\n\n  opts = Object.assign(defaultOpts, opts);\n\n  var headers = {};\n\n  for (var k in opts.headers) {\n    headers[k.toLowerCase()] = opts.headers[k];\n  }\n\n  var data2 = [];\n\n  if (typeof data == 'object') {\n    // format data\n    if (headers['content-type'] == 'application/json') {\n      data = JSON.stringify(data);\n    } else {\n      for (var index in data) {\n        if (data.hasOwnProperty(index)) {\n          data2[data2.length] = index + '=' + data[index];\n        }\n      }\n      data = data2.join('&');\n    }\n  }\n\n  if (typeof XMLHttpRequest !== 'undefined') {\n    xhr = new XMLHttpRequest();\n  } else {\n    var versions = [\n      'MSXML2.XmlHttp.5.0',\n      'MSXML2.XmlHttp.4.0',\n      'MSXML2.XmlHttp.3.0',\n      'MSXML2.XmlHttp.2.0',\n      'Microsoft.XmlHttp',\n    ];\n\n    for (var i = 0, len = versions.length; i < len; i++) {\n      try {\n        xhr = new ActiveXObject(versions[i]);\n        break;\n      } catch (e) {}\n    } // end for\n  }\n\n  var ua = navigator.userAgent.toLowerCase();\n\n  xhr.onreadystatechange = function () {\n    // https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/getAllResponseHeaders\n    if (this.readyState === this.HEADERS_RECEIVED) {\n      // Get the raw header string\n      var headers = xhr.getAllResponseHeaders();\n      // Convert the header string into an array\n      // of individual headers\n      var arr = headers.trim().split(/[\\r\\n]+/);\n\n      // Create a map of header names to values\n      var headerMap = {};\n      arr.forEach(function (line) {\n        var parts = line.split(': ');\n        var header = parts.shift().toLowerCase();\n        var value = parts.join(': ');\n        headerMap[header] = value;\n      });\n\n      // console.log(headerMap['content-type']);\n\n      xhr.headers = headerMap;\n    }\n  };\n\n  if (\n    ua.indexOf('msie') != -1 &&\n    ua.indexOf('opera') == -1 &&\n    ua.indexOf('webtv') == -1\n  ) {\n    xhr.onreadystatechange = function () {\n      if (this.readyState === 4) {\n        if (this.status >= 200 && this.status < 400) {\n          // Success!\n          success_callback(xhr);\n        } else {\n          // Error :(\n          failure_callback(xhr);\n        }\n      }\n    };\n  } else {\n    xhr.onload = function (e) {\n      if (this.status == 200) {\n        // console.log(xhr.data);\n        success_callback(xhr);\n      } else {\n        failure_callback(xhr);\n      }\n    };\n  }\n\n  if (!method) {\n    method = 'GET';\n  }\n\n  method = method.toUpperCase();\n\n  url = formatURL(url);\n\n  console.log(url);\n\n  xhr.open(method, url, true);\n\n  xhr.withCredentials = true;\n\n  if (opts.responseType) {\n    xhr.responseType = opts.responseType;\n  }\n\n  for (var key in headers) {\n    xhr.setRequestHeader(key, headers[key]);\n  }\n\n  xhr.send(data);\n}\n\nfunction formatURL(url) {\n  if (isAbsoluteUrl(url)) {\n    return url;\n  }\n\n  url = new URL(url, document.baseURI).href;\n\n  return url;\n}\n\nclass Ajax {\n  constructor({\n    methods = ['get', 'post', 'head', 'put', 'post', 'patch', 'delete'],\n  } = {}) {\n    var self = this;\n\n    methods.forEach(function (method) {\n      self[method] = function (url, data, opts = {}) {\n        return this.__fetch(url, method, data, opts);\n      };\n    });\n  }\n\n  __fetch(url, method, data, opts) {\n    // console.log({data});\n    return new Promise(function (resolve, reject) {\n      httpRequest(\n        url,\n        method,\n        data,\n        opts,\n        function (xhr) {\n          // console.log(\">>>>\", xhr.response==xhr.responseText);\n          // console.log(xhr);\n          resolve({ data: xhr.response, headers: xhr.headers });\n        },\n        reject\n      );\n    });\n  }\n}\n\nexport default new Ajax();\n","/**\n * Copyright (c) 2024 Anthony Mugendi\n * \n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\n//source: https://github.com/chrisdavies/eev\n\nexport default (function () {\n    var id = 0;\n    var splitter = /[\\s,]+/g;\n  \n    // A relatively generic LinkedList impl\n    function LinkedList(linkConstructor) {\n      this.head = new RunnableLink();\n      this.tail = new RunnableLink(this.head);\n      this.head.next = this.tail;\n      this.linkConstructor = linkConstructor;\n      this.reg = {};\n    }\n  \n    LinkedList.prototype = {\n\n      insert: function (data) {\n        var link = new RunnableLink(this.tail.prev, this.tail, data);\n        link.next.prev = link.prev.next = link;\n        return link;\n      },\n  \n      remove: function (link) {\n        link.prev.next = link.next;\n        link.next.prev = link.prev;\n      }\n    };\n  \n    // A link in the linked list which allows\n    // for efficient execution of the callbacks\n    function RunnableLink(prev, next, fn) {\n      this.prev = prev;\n      this.next = next;\n      this.fn = fn || noop;\n    }\n  \n    RunnableLink.prototype.run = function (data) {\n      this.fn(data);\n      this.next && this.next.run(data);\n    };\n  \n    function noop () { }\n  \n    function Eev () {\n      this.events = {};\n    }\n  \n    Eev.prototype = {\n      constructor: Eev,\n  \n      on: function (names, fn, ctx) {\n        var me = this;\n\n        fn = fn.bind(ctx||null);\n        // console.log('ctx', ctx);\n  \n        names.split(splitter).forEach(function (name) {\n          var list = me.events[name] || (me.events[name] = new LinkedList());\n          var eev = fn._eev || (fn._eev = (++id));\n  \n          list.reg[eev] || (list.reg[eev] = list.insert(fn));\n        });\n      },\n  \n      off: function (names, fn) {\n        var me = this;\n        fn && names.split(splitter).forEach(function (name) {\n          var list = me.events[name];\n  \n          if (!list) {\n            return;\n          }\n  \n          var link = list.reg[fn._eev];\n  \n          list.reg[fn._eev] = undefined;\n  \n          list && link && list.remove(link);\n        });\n      },\n  \n      emit: function (name, data) {\n        var evt = this.events[name];\n        evt && evt.head.run(data);\n      }\n    };\n  \n    return Eev;\n  }());","export default class DbStorage {\n  constructor(options) {\n    this.name = options.name;\n  }\n\n  async getItem(key) {\n    var store = await this.__getStore();\n    return awaitRequest(store.get(key), 'Failed to get item');\n  }\n\n  async setItem(key, value) {\n    var store = await this.__getStore();\n    return awaitRequest(store.put(value, key), 'Failed to set item');\n  }\n\n  async removeItem(key) {\n    var store = await this.__getStore();\n    return awaitRequest(store.delete(key), 'Failed to remove item');\n  }\n\n  async clear() {\n    var store = await this.__getStore();\n    return awaitRequest(store.clear(), 'Failed to clear store');\n  }\n\n  async __getStore() {\n    var db = await this.__initDb();\n    return db.transaction('store', 'readwrite').objectStore('store');\n  }\n\n  __initDb() {\n    if (this.db === undefined) {\n      this.db = this.__openDb();\n    }\n    return this.db;\n  }\n\n  __openDb() {\n    var request = indexedDB.open(this.name, 1);\n\n    request.addEventListener('upgradeneeded', function () {\n      // e.oldVersion\n      // e.newVersion\n      var db = request.result;\n      db.createObjectStore('store');\n    });\n\n    return awaitRequest(request, 'Failed to open IndexedDB');\n  }\n}\n\nfunction awaitRequest(request, errorMessage) {\n  return new Promise(function (resolve, reject) {\n    request.addEventListener('success', function () {\n      resolve(request.result);\n    });\n    request.addEventListener('error', function () {\n      reject(errorMessage);\n    });\n  });\n}\n","// wrapper for localstorage to enable domain based storage\n\nexport default class LocalStorage {\n  constructor(options) {\n    this.name = options.name;\n\n    var methods = ['getItem', 'setItem', 'removeItem', 'clear'];\n\n    for (var i in methods) {\n      this[methods[i]] = function (methodName) {\n        var args = arguments;\n        var key = this.__formatKey(args[1]);\n        var value = args[2];\n        var resp;\n\n        if (value) {\n          value = JSON.stringify(value);\n        }\n\n        if (value) {\n          resp = localStorage[methodName](key, value);\n        } else {\n          resp = localStorage[methodName](key);\n        }\n\n        if (resp) {\n          resp = JSON.parse(resp);\n        }\n\n        return resp;\n      }.bind(this, methods[i]);\n    }\n  }\n\n  __formatKey(key) {\n    return [this.name, key].join(':');\n  }\n}\n","/**\n * Copyright (c) 2024 Anthony Mugendi\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\n'use strict';\n\nimport DbStorage from './dbs/indexed-db.js';\nimport LocalStorage from './dbs/localstorage.js';\n\n\nclass Store {\n  constructor(options = {}) {\n    this.options = Object.assign(\n      { name: window.location.host, debug: false },\n      options\n    );\n    // initialize store\n    return this.initStore();\n  }\n\n  initStore() {\n    var indexedDB =\n      window.indexedDB ||\n      window.webkitIndexedDB ||\n      window.mozIndexedDB ||\n      window.msIndexedDB;\n\n    var db;\n\n    if (indexedDB) {\n      db = new DbStorage(this.options);\n      db.dbType = 'indexedDB';\n    } else if (window.localStorage) {\n      db = new LocalStorage(this.options);\n      db.dbType = 'localStorage';\n    }\n\n    if (this.options.debug) {\n      console.log(`Database Used: `, db.dbType);\n    }\n\n    return db;\n  }\n}\n\nexport default Store;\n","export function toDate(argument) {\n  var argStr = Object.prototype.toString.call(argument);\n\n  // Clone the date\n  if (\n    argument instanceof Date ||\n    (typeof argument === 'object' && argStr === '[object Date]')\n  ) {\n    // Prevent the date to lose the milliseconds when passed to new Date() in IE10\n    return new argument.constructor(+argument);\n  } else if (\n    typeof argument === 'number' ||\n    argStr === '[object Number]' ||\n    typeof argument === 'string' ||\n    argStr === '[object String]'\n  ) {\n    // TODO: Can we get rid of as?\n    return new Date(argument);\n  } else {\n    // TODO: Can we get rid of as?\n    return new Date(NaN);\n  }\n}\n\nexport function constructFrom(date, value) {\n  if (date instanceof Date) {\n    return new date.constructor(value);\n  } else {\n    return new Date(value);\n  }\n}\n\nexport function addMilliseconds(date, amount) {\n  var timestamp = +toDate(date);\n  return constructFrom(date, timestamp + amount);\n}\n\nexport function addSeconds(date, amount) {\n  return addMilliseconds(date, amount * 1000);\n}\n\nexport function isBefore(date, dateToCompare) {\n  var _date = toDate(date);\n  var _dateToCompare = toDate(dateToCompare);\n  return +_date < +_dateToCompare;\n}\n","/**\n * Copyright (c) 2023 Anthony Mugendi\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n'use strict';\n\nexport function arrify(v) {\n  if (v === undefined) return [];\n  return Array.isArray(v) ? v : [v];\n}\n\nexport function toDataURI(content) {\n  // ony work with blobs\n  if (content instanceof Blob == false) return Promise.resolve(content);\n\n  return new Promise(function (resolve, reject) {\n    var reader = new FileReader();\n    reader.onloadend = function () {\n      resolve(reader.result);\n    };\n    reader.readAsDataURL(content);\n  });\n}\n\nexport function injectScript(script) {\n  var tagEl;\n\n  // https://sourcemaps.info/spec.html\n  var sourceURL = `//# sourceURL=${script.url};`;\n  var content = script.content.data;\n\n  var headEl =\n    document.querySelector('head') ||\n    document.querySelector('body') ||\n    document.querySelector('html');\n\n\n  if (script.content.type == 'javascript') {\n    tagEl = document.createElement('script');\n    tagEl.setAttribute('type', 'text/javascript');\n    // add source url\n    content += `\\n${sourceURL}`;\n  } else if (script.content.type == 'css') {\n    tagEl = document.createElement('style');\n    tagEl.setAttribute('type', 'text/css');\n    tagEl.setAttribute('rel', 'stylesheet');\n    // add source url\n    content += `\\n/* ${sourceURL} */`;\n  }\n\n  tagEl.setAttribute('data-url', script.url);\n  tagEl.textContent = content;\n\n  headEl.appendChild(tagEl);\n\n  // return\n  return tagEl;\n}\n\n\nexport function delay (time=1000) {\n   return new Promise((resolve) => setTimeout(resolve, time));\n}\n\nexport function hash(s) {\n  s = String(s);\n  var h = 0,\n    l = s.length,\n    i = 0;\n  if (l > 0) while (i < l) h = ((h << 5) - h + s.charCodeAt(i++)) | 0;\n  return 'h' + String(h).replace('-', 'Z');\n}\n\nexport function merge(target, source) {\n  // Iterate through `source` properties and if an `Object` set property to merge of `target` and `source` properties\n  for (var key of Object.keys(source)) {\n    if (source[key] instanceof Object)\n      Object.assign(source[key], merge(target[key] || {}, source[key]));\n  }\n\n  // Join `target` and modified `source`\n  Object.assign(target || {}, source);\n  return target;\n}\n\n\nexport function getHost() {\n  // obtain plugin path from the script element\n  var src;\n  var path = '/scriptin.js';\n\n  if (document.currentScript) {\n    src = document.currentScript.src;\n  } else {\n    var sel = document.querySelector('script[src$=\"'+path+'\"]')\n    if (sel) {\n      src = sel.src;\n    }\n  }\n\n\n  return src.replace(path,'');\n}\n\n\nexport function isClass(val) {\n  if(!val) return false\n  var propertyNames = Object.getOwnPropertyNames(val);\n  return propertyNames.includes('prototype') && !propertyNames.includes('arguments');\n}\n\nexport function isFunction(val) {\n  return typeof val === 'function' && !isClass(val);\n}\n\nexport function isAbsoluteURL(url){\n  return /^(?:[a-z+]+:)?\\/\\//.test(url)\n}\n\nexport function titleCase(str) {\n  str = str.toLowerCase().split(' ');\n  for (var i = 0; i < str.length; i++) {\n    str[i] = str[i].charAt(0).toUpperCase() + str[i].slice(1); \n  }\n  return str.join(' ');\n}","/**\n * Copyright (c) 2024 Anthony Mugendi\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nexport const pluginsOrder = ['IsLoading', 'Details', 'AutoResource'];\n","/**\n * Copyright (c) 2023 Anthony Mugendi\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\n\"use strict\";\n\nimport ajax from \"./lib/ajax.js\";\nimport Eev from \"./lib/events.js\";\nimport Store from \"./lib/store/index.js\";\nimport { addSeconds, isBefore } from \"./lib/utils/dateFns.js\";\nimport { getHeaderType, hasExpiredHeader } from \"./lib/utils/headers.js\";\nimport {\n  arrify,\n  getHost,\n  hash,\n  injectScript,\n  isAbsoluteURL,\n  isClass,\n  merge,\n  toDataURI,\n} from \"./lib/utils/general.js\";\nimport { pluginsOrder } from \"./lib/settings.js\";\n\n// these characters are used in place of +ve/affirmative or the opposite statements and words\n// This is done on purpose in a bid to make this script as tiny as possible\n// For Example, we save the cache status for scripts as { \"enabled\": \"✓\", \"status\": \"✖\"}\n// This translates to : \"cache enabled\" but current status of data is that it \"was not\" read from cache.\n// One of the key goals is to make Scriptin as small as possible. A resource loader cannot be the first thing taking forever to load\nvar Y = \"✓\";\nvar N = \"✖\";\n\nvar scriptHost = getHost();\n\nclass Scriptin {\n  constructor(options = {}) {\n    this.scriptHost = scriptHost;\n\n    this.options = merge(\n      { ttl: 0, injectToHead: true, debug: false, ignoreURLParams: true },\n      options,\n    );\n\n    this.events = new Eev();\n    this.ajax = ajax;\n    this.store = new Store();\n\n    this.Scriptin = this;\n\n    this.__init();\n    this.loadedPlugins = {};\n  }\n\n  __init() {\n    this.__listener();\n    this.__init_plugins();\n  }\n\n  on(evs, fn) {\n    evs = arrify(evs);\n    for (var i in evs) {\n      this.events.on(evs[i], fn);\n    }\n  }\n\n  async load(scripts, options) {\n    try {\n      var self = this;\n      // console.log(12, { scripts });\n      // 1. ensure is array\n      scripts = arrify(scripts);\n      // 2. Filter & format scripts\n      var script;\n\n      var promises = [];\n\n      // load each script\n      for (var i in scripts) {\n        script = scripts[i];\n        // if null, skip and continue\n        if (!!script === false) continue;\n        // only use objects\n        if (typeof script == \"string\") script = { url: script };\n\n        // make script key\n        var urlKeyVal = script.url;\n\n        if (this.options.ignoreURLParams) {\n          urlKeyVal = urlKeyVal.replace(/[#\\?].+$/, \"\");\n        }\n\n        // default cache to true\n        script.cache = script.cache === false ? false : true;\n        // default ttl to script.ttl or options.ttl or 0\n        script.ttl = script.ttl || this.options.ttl || 0;\n        // add meta & key\n        script.meta = { key: hash(urlKeyVal) };\n\n        // 3. Now load script\n        var loadedScript = await this.__loadScript(script);\n\n        promises.push(loadedScript);\n\n        if (loadedScript) {\n          var event = options?.event || \"loaded\";\n          var parent = options?.parent;\n\n          loadedScript.parent = parent;\n\n          self.events.emit(event, loadedScript);\n          self.events.emit(loadedScript.url, loadedScript);\n          self.events.emit(loadedScript.content.type, loadedScript);\n          self.events.emit(loadedScript.content.category, loadedScript);\n        }\n      }\n\n      return await Promise.all(promises).then((resp) => {\n        var obj = {};\n        for (var i in resp) {\n          obj[resp[i].url] = resp[i];\n        }\n\n        return obj;\n      });\n    } catch (error) {\n      // Handle all errors\n\n      if (self?.options?.debug) console.error({ error });\n\n      var stack = error.stack || /*old opera*/ error.stacktrace;\n      var errObj = {\n        error: {\n          status: error.status || error.message,\n          details: error.statusText || stack,\n        },\n        script: script,\n      };\n\n      self.events.emit(\"error\", errObj);\n    }\n  }\n\n  async __init_plugins() {\n    var self = this;\n    try {\n      self.pluginsLoaded = self.pluginsLoaded || [];\n\n      // load\n      self.events.on(\"plugin-loaded\", async function (script) {\n        var name = script.url.split(\"/\").pop().replace(/\\.js$/, \"\");\n        var cName = \"ScriptIn\" + name;\n        var cls = window[cName];\n        var parent = script.parent;\n\n        if (isClass(cls)) {\n          // pass all methods of Scriptin class\n\n          let plugin = new cls(merge(self, { pluginName: name, parent }));\n\n          if (plugin.dependencies) {\n            var deps = arrify(plugin.dependencies);\n\n            // do not load existing deps\n            // console.log(deps, self.pluginsLoaded);\n            // load plugin deps\n            await self.__loadPlugins(deps, name);\n          }\n\n          // init\n          plugin.init && plugin.init();\n        }\n      });\n\n      // order plugins properly\n      var pluginsObjKeys = Object.keys(this.options.plugins);\n      var plugins = pluginsOrder.filter((p) => pluginsObjKeys.indexOf(p) > -1);\n\n      // load plugins\n      await this.__loadPlugins(plugins);\n\n      // await\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async __loadPlugins(plugins, parent) {\n    var plugin;\n\n    //\n    for (var i in plugins) {\n      plugin = plugins[i];\n\n      var url;\n\n      // load plugin from absolute link too\n      if (isAbsoluteURL(plugins[i])) {\n        url = plugins[i];\n      } else {\n        url = this.scriptHost + \"/plugins/\" + plugin + \".js\";\n      }\n\n      if (this.pluginsLoaded.indexOf(url) > -1) continue;\n\n      this.pluginsLoaded.push(url);\n\n      await this.load(url, { event: \"plugin-loaded\", parent });\n    }\n  }\n\n  async __loadScript(script) {\n    var self = this;\n    var now = new Date();\n\n    script.meta.cache = { enabled: N };\n\n    // if script has test and failing test, return\n    if (\"test\" in script && !!script.test === false) {\n      this.__log('\"' + script.url + '\" is skipped as the test failed.');\n      return null;\n    }\n\n    // if script.cache\n    if (script.cache) {\n      // show that cache is enabled\n      script.meta.cache.enabled = Y;\n      script.meta.cache.status = N;\n\n      // this.__log(script.url, 'is cached!');\n      var cachedScript = await this.store.getItem(script.meta.key);\n\n      if (cachedScript) {\n        var cacheStatusDirty = false;\n        // now we have a script cached\n        // But there are conditions which would make us reject this cache status. These are\n        // 1.ttl has not changed\n        cacheStatusDirty = script.ttl !== cachedScript.ttl;\n\n        // 2. script.returnType has changed\n        cacheStatusDirty = script.returnType !== cachedScript.returnType;\n\n        if (!cacheStatusDirty) {\n          // set cache status to Y\n          script.meta.cache.status = Y;\n          script = merge(cachedScript, script);\n        }\n      }\n    }\n\n    // if script is cached....\n    if (script.meta.cache.status == Y) {\n      // Check that cache has not expired using TTL\n      if (\n        typeof script.ttl == \"number\" &&\n        script.ttl > 0 &&\n        script.meta.fetched\n      ) {\n        var cacheExpiresAt = addSeconds(script.meta.fetched, script.ttl);\n        var hasExpired = isBefore(cacheExpiresAt, now);\n\n        // if script still\n        if (hasExpired) {\n          // delete cache record\n          await self.store.removeItem(script.meta.key);\n          // toggle cached status\n          script.meta.cache.status = N;\n          // delete content property\n          delete script.content;\n        }\n      }\n\n      // 2. check that script has not been modified\n      // We do so by calling the head method on the script and comparing last-modified/maxage headers\n      self.__validateCache(script);\n    }\n\n    // If not cached...\n    if (script.meta.cache.status == N) {\n      // We got here, so fetch the script\n      // Cache script if script cache is enabled\n      var resp = await self.__fetchScript(script);\n\n      var contentLength = parseFloat(resp.headers[\"content-length\"]) || null;\n\n      // console.log(JSON.stringify(resp.headers,0,4));\n      script.content = resp.content;\n      script.meta.fetched = now;\n      script.meta.size = contentLength;\n\n      // if script can be cached, then cache\n      if (script.meta.cache.enabled == Y) {\n        self.store.setItem(script.meta.key, script);\n      }\n    }\n\n    // Inject to header if need be\n    if (\n      self.options.injectToHead &&\n      (script.content.type == \"javascript\" || script.content.type == \"css\")\n    ) {\n      injectScript(script);\n    }\n\n    // return script\n    return script;\n  }\n\n  __listener() {\n    var self = this;\n\n    // listen for cntrl + R\n    async function KeyPress(e) {\n      // console.log(e);\n      // e.preventDefault();\n\n      KeyPress.keys = KeyPress.keys || [];\n      KeyPress.intVar = KeyPress.intVar;\n\n      clearTimeout(KeyPress.intVar);\n      KeyPress.intVar = setTimeout(function () {\n        KeyPress.keys = [];\n      }, 1000);\n\n      if (e.ctrlKey && KeyPress.keys.indexOf(\"CTRL\") == -1) {\n        KeyPress.keys.push(\"CTRL\");\n      }\n\n      if (e.code) {\n        KeyPress.keys.push(e.code);\n      }\n\n      // console.log(KeyPress.keys);\n\n      if (\n        KeyPress.keys.indexOf(\"KeyR\") > -1 &&\n        KeyPress.keys.indexOf(\"CTRL\") > -1\n      ) {\n        e.preventDefault();\n        await self.store.clear();\n        window.location.reload();\n      }\n    }\n\n    document.addEventListener(\"keydown\", KeyPress);\n\n    // Listen for dirty state\n    var intVar;\n\n    this.events.on(\"stateIsDirty\", function () {\n      //  prevent multiple reloads\n      clearTimeout(intVar);\n      intVar = setTimeout(function () {\n        window.location.reload();\n      }, 1000);\n    });\n  }\n\n  async __validateCache(script) {\n    var self = this;\n    // console.log(JSON.stringify(script, 0, 4));\n    // 1. Make head request\n    var resp = await ajax.head(script.url);\n    var hasExpired = hasExpiredHeader(resp.headers, script.meta.fetched);\n\n    if (hasExpired) {\n      self.__log(\n        '\"' +\n          script.url +\n          '\" has expired or been modified. Cache will be invalidated and server reloaded.',\n      );\n\n      // emit\n      self.events.emit(\"stateIsDirty\", true);\n\n      // delete from cache\n      await self.store.removeItem(script.meta.key);\n    }\n  }\n\n  async __fetchScript(script) {\n    // ajax fetch\n\n    this.__log(\"fetching \", script.url);\n    // 1. if returnType == 'dataURI' then we want to set  responseType = 'blob';\n    var responseType = null;\n    var isDataURI = script.returnType === \"dataURI\";\n    if (isDataURI) {\n      responseType = \"blob\";\n    }\n\n    // 2.make ajax Get request\n    var resp = await ajax.get(script.url, {}, { responseType: responseType });\n\n    // get/make data URI\n    if (isDataURI) {\n      var dataURL = await toDataURI(resp.data);\n      resp = merge(resp, { data: dataURL });\n    }\n\n    // get content type based on headers\n    var typeObj = getHeaderType(resp.headers);\n    var contentData = resp.data;\n\n    // if json type, then attempt to parse\n    if (typeObj.type == \"json\") {\n      try {\n        contentData = JSON.parse(contentData);\n      } catch (error) {\n        console.error(error);\n      }\n    }\n\n    contentData = merge({ data: contentData }, typeObj);\n\n    // content object and headers\n    return { content: contentData, headers: resp.headers };\n  }\n\n  __log() {\n    if (this.options.debug) console.log.apply(null, arguments);\n  }\n}\n\nexport default Scriptin;\n","/**\n * Copyright (c) 2024 Anthony Mugendi\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nimport { isBefore, addSeconds } from './dateFns';\n\nexport function getHeaderType(headers) {\n  // console.log(script);\n  var contentType = (headers['content-type'] || '').toLowerCase();\n  var arr = contentType.split(';')[0].split('/');\n\n  return { category: arr[0] || \"?\", type: arr[1] || arr[0] || \"?\" };\n}\n\nexport function hasExpiredHeader(headers, dateFetched) {\n  // if last modified header\n  if (\n    headers['last-modified'] &&\n    isBefore(dateFetched, new Date(headers['last-modified']))\n  ) {\n    return true;\n  }\n\n  // use expires headers\n  if (\n    headers['expires'] &&\n    isBefore(new Date(headers['expires']), dateFetched)\n  ) {\n    // return true;\n  }\n\n  //otherwise check using max age\n  if (headers['cache-control']) {\n    var arr = headers['cache-control']\n      .split(',')\n      .map(function (v) {\n        return v.split('=');\n      })\n      .filter(function (arr) {\n        return arr.length == 2 && arr[0].indexOf('age') > -1;\n      })\n      .map(function (a) {\n        return parseInt(a[1]);\n      });\n\n    var maxAge = arr[0];\n    var expiresOn = addSeconds(dateFetched, maxAge);\n\n    if (isBefore(expiresOn, dateFetched)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n"],"names":["ABSOLUTE_URL_REGEX","WINDOWS_PATH_REGEX","httpRequest","url","method","data","opts","success_callback","failure_callback","xhr","defaultOpts","headers","toUpperCase","indexOf","Object","assign","k","toLowerCase","data2","JSON","stringify","index","hasOwnProperty","length","join","XMLHttpRequest","versions","i","len","ActiveXObject","e","ua","navigator","userAgent","key","onreadystatechange","this","readyState","HEADERS_RECEIVED","arr","getAllResponseHeaders","trim","split","headerMap","forEach","line","parts","header","shift","value","status","onload","TypeError","test","isAbsoluteUrl","URL","document","baseURI","href","formatURL","console","log","open","withCredentials","responseType","setRequestHeader","send","ajax","constructor","methods","self","__fetch","Promise","resolve","reject","response","Eev","id","splitter","LinkedList","linkConstructor","head","RunnableLink","tail","next","reg","prev","fn","noop","events","prototype","insert","link","remove","run","on","names","ctx","me","bind","name","list","eev","_eev","off","undefined","emit","evt","DbStorage","options","getItem","_this","_asyncToGenerator","awaitRequest","__getStore","get","setItem","_this2","put","removeItem","_this3","delete","clear","_this4","_this5","__initDb","transaction","objectStore","db","__openDb","request","indexedDB","addEventListener","result","createObjectStore","errorMessage","LocalStorage","methodName","resp","args","arguments","__formatKey","localStorage","parse","Store","window","location","host","debug","initStore","webkitIndexedDB","mozIndexedDB","msIndexedDB","dbType","toDate","argument","argStr","toString","call","_instanceof","Date","NaN","addMilliseconds","date","amount","constructFrom","addSeconds","isBefore","dateToCompare","arrify","v","Array","isArray","hash","s","h","l","String","charCodeAt","replace","merge","target","source","keys","isAbsoluteURL","pluginsOrder","Y","N","scriptHost","src","path","currentScript","sel","querySelector","getHost","ttl","injectToHead","ignoreURLParams","store","Scriptin","__init","loadedPlugins","__listener","__init_plugins","evs","load","scripts","script","promises","urlKeyVal","cache","meta","loadedScript","__loadScript","push","event","parent","content","type","category","all","then","obj","error","_self$options","stack","stacktrace","errObj","message","details","statusText","pluginsLoaded","_ref","pop","cls","val","propertyNames","getOwnPropertyNames","includes","isClass","plugin","pluginName","dependencies","deps","__loadPlugins","init","_x","apply","pluginsObjKeys","plugins","filter","p","now","enabled","__log","cachedScript","returnType","fetched","__validateCache","__fetchScript","contentLength","parseFloat","size","tagEl","sourceURL","headEl","createElement","setAttribute","textContent","appendChild","injectScript","intVar","KeyPress","_x2","_KeyPress","clearTimeout","setTimeout","ctrlKey","code","preventDefault","reload","dateFetched","map","a","parseInt","_this6","isDataURI","Blob","reader","FileReader","onloadend","readAsDataURL","typeObj","contentData"],"mappings":"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"}